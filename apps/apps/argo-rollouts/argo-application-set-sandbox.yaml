apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: argo-rollouts-sandbox
  namespace: argocd
spec:
  generators:
    - matrix:
        generators:
          - git:
              repoURL: git@github.com:templarfelix/akuity-appofapps.git
              revision: HEAD
              files:
              - path: apps/_cluster_config/sandbox/**/**/config.yaml
              pathParamPrefix: target
          - git:
              repoURL: git@github.com:templarfelix/akuity-appofapps.git
              revision: HEAD
              files:
              - path: apps/_dataset_config/sandbox/config.yaml
              pathParamPrefix: app
  template:
    metadata:
      name: 'argo-rollouts-{{values.suffix}}'
    spec:
      project: "argo-rollouts"
      source:
        # https://artifacthub.io/packages/helm/argo/argo-rollouts
        repoURL: https://argoproj.github.io/argo-helm
        chart: argo-rollouts
        targetRevision: 2.38.0
        helm:
          valuesObject:
            dashboard:
              enabled: true	
            controller:
              metrics:
                enabled: true	
                service:
                  annotations:
                    prometheus.io/scrape: "true"
                    prometheus.io/path: /metrics
                    prometheus.io/port: "8090"
          passCredentials: false
          releaseName: argo-rollouts
          ignoreMissingValueFiles: false
          skipCrds: false
          version: v3
      destination:
        name: '{{server}}'
        namespace: argo-rollouts
      syncPolicy: 
        syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground