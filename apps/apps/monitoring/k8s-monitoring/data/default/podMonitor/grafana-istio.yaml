apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: istio-proxy-monitor
  namespace: monitoring
spec:
  selector:
    matchLabels:
      security.istio.io/tlsMode: "istio"
  namespaceSelector:
    any: true
  podMetricsEndpoints:
  - port: http-envoy-prom
    honorLabels: true
    honorTimestamps: false
    interval: 30s
    path: /stats/prometheus
    relabelings:
    - action: replace
      sourceLabels:
      - __meta_kubernetes_pod_label_squad
      targetLabel: squad
    - action: labeldrop
      regex: __meta_kubernetes_pod_label_skaffold_dev.*
    - action: labeldrop
      regex: __meta_kubernetes_pod_label_pod_template_hash.*
    - action: labeldrop
      regex: "__meta_kubernetes_pod_label_(.+)"
    - replacement: integrations/kubernetes/istio-proxy
      targetLabel: job
    metricRelabelings:
    - action: replace
      targetLabel: job
      replacement: integrations/kubernetes/istio-proxy
    - action: drop
      regex: (outbound|inbound|prometheus_stats).*
      sourceLabels:
      - cluster_name
    - action: drop
      regex: (outbound|inbound|prometheus_stats).*
      sourceLabels:
      - tcp_prefix
    - action: drop
      regex: (.+)
      sourceLabels:
      - listener_address
    - action: drop
      regex: (.+)
      sourceLabels:
      - http_conn_manager_listener_prefix
    - action: drop
      regex: (.+)
      sourceLabels:
      - http_conn_manager_prefix
    - action: drop
      regex: envoy_tls.*
      sourceLabels:
      - __name__
    - action: drop
      regex: envoy_tcp_downstream.*
      sourceLabels:
      - __name__
    - action: drop
      regex: envoy_http_(stats|admin).*
      sourceLabels:
      - __name__
    - action: drop
      regex: envoy_cluster_(lb|retry|bind|internal|max|original).*
      sourceLabels:
      - __name__
    - action: drop
      regex: istio_request_bytes_bucket|istio_request_bytes_count|istio_request_bytes_sum|istio_response_bytes_bucket|istio_response_bytes_sum|istio_response_bytes_count
      sourceLabels:
        - __name__